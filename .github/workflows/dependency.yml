name: Weekly Dependency Maintenance

on:
  schedule:
    # Run every Wednesday at 03:30 UTC
    - cron: "30 3 * * 3"
  workflow_dispatch: # manual trigger option
  pull_request:
  push:
    branches:
      - main

jobs:
  refresh-dependencies:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Fetch the repository contents
      - name: Retrieve repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2️⃣ Configure Node.js runtime
      - name: Set up Node environment
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # 3️⃣ Install current dependency versions
      - name: Install existing dependencies
        run: npm ci || npm install

      # 4️⃣ Identify outdated packages (non-blocking)
      - name: Scan for outdated packages
        run: |
          echo "🔍 Checking for outdated dependencies..."
          npm outdated || true

      # 5️⃣ Update all outdated dependencies
      - name: Perform dependency upgrades
        run: |
          echo "⬆️ Updating dependencies..."
          npm update

      # 6️⃣ Run project tests to confirm stability
      - name: Verify with test suite
        run: |
          echo "🧪 Running Jest tests after updates..."
          npm test || true

      # 7️⃣ Create pull request for updated packages
      - name: Open automated PR for dependency updates
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: "chore(deps): weekly dependency refresh"
          branch: "auto-dep-updates"
          title: "Weekly Dependency Refresh"
          body: |
            This pull request includes the latest dependency updates.
            - Automatically generated by GitHub Actions 🤖
            - Run scheduled at **03:30 UTC every Wednesday**
          labels: ["automation", "dependencies"]
